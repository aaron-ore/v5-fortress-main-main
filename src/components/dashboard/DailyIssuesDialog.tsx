import React, { useState, useEffect } from "react";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { ScrollArea } from "@/components/ui/scroll-area";
import { AlertTriangle, User, Clock, MapPin, Package } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import { useProfile, UserProfile } from "@/context/ProfileContext"; // Corrected import
import { showError } from "@/utils/toast";
import { format, startOfDay, endOfDay, isValid } from "date-fns";
import { DateRange } from "react-day-picker";
import { parseAndValidateDate } from "@/utils/dateUtils";
import { useOnboarding } from "@/context/OnboardingContext"; // Import useOnboarding for folder names

interface DailyIssuesDialogProps {
  isOpen: boolean;
  onClose: () => void;
  dateRange: DateRange | undefined;
}

interface IssueLog {
  id: string;
  timestamp: string;
  userId: string;
  organizationId: string;
  activityType: string;
  description: string;
  details: {
    issueType: string;
    itemId: string;
    itemName: string;
    folderId: string; // Changed from location to folderId
    contactInfo: string;
    description: string;
  };
}

const DailyIssuesDialog: React.FC<DailyIssuesDialogProps> = ({ isOpen, onClose, dateRange }) => {
  const { profile, allProfiles, fetchAllProfiles } = useProfile();
  const { inventoryFolders } = useOnboarding(); // Get inventory folders
  const [issues, setIssues] = useState<IssueLog[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    if (isOpen && profile?.organizationId) {
      setIsLoading(true);
      const fetchIssues = async () => {
        let query = supabase
          .from('activity_logs')
          .select('*')
          .eq('organization_id', profile.organizationId)
          .eq('activity_type', 'Issue Reported')
          .order('timestamp', { ascending: false });

        const today = new Date();
        const filterFrom = (dateRange?.from && isValid(dateRange.from)) ? startOfDay(dateRange.from) : startOfDay(today);
        const filterTo = (dateRange?.to && isValid(dateRange.to)) ? endOfDay(dateRange.to) : ((dateRange?.from && isValid(dateRange.from)) ? endOfDay(dateRange.from) : endOfDay(today));

        query = query.gte('timestamp', filterFrom.toISOString()).lte('timestamp', filterTo.toISOString());

        const { data, error } = await query;

        if (error) {
          console.error("Error fetching issues for dialog:", error);
          showError("Failed to load issues.");
          setIssues([]);
        } else {
          const fetchedIssues: IssueLog[] = data.map((log: any) => ({
            id: log.id,
            timestamp: parseAndValidateDate(log.timestamp)?.toISOString() || new Date().toISOString(),
            userId: log.user_id, // Corrected: user_id is directly on the log object
            organizationId: log.organization_id,
            activityType: log.activity_type,
            description: log.description,
            details: {
              issueType: log.details.issueType,
              itemId: log.details.itemId,
              itemName: log.details.itemName,
              folderId: log.details.folderId || log.details.location || "N/A", // Map to folderId, fallback to old location if exists
              contactInfo: log.details.contactInfo,
              description: log.details.description,
            },
          }));
          setIssues(fetchedIssues);
        }
        setIsLoading(false);
      };

      fetchIssues();
      fetchAllProfiles();
    }
  }, [isOpen, profile?.organizationId, fetchAllProfiles, dateRange]);

  const getUserName = (userId: string) => {
    const user = allProfiles.find((p: UserProfile) => p.id === userId); // Explicitly type p
    return user?.fullName || user?.email || "Unknown User";
  };

  // Function to get folder display name
  const getFolderName = (folderId: string) => {
    const foundFolder = inventoryFolders.find(folder => folder.id === folderId);
    return foundFolder?.name || "Unknown Folder";
  };

  const getDisplayDateRange = () => {
    const today = new Date();
    const filterFrom = (dateRange?.from && isValid(dateRange.from)) ? dateRange.from : today;
    const filterTo = (dateRange?.to && isValid(dateRange.to)) ? dateRange.to : today;

    if (format(filterFrom, "yyyy-MM-dd") === format(filterTo, "yyyy-MM-dd")) {
      return format(filterFrom, "MMM dd, yyyy");
    } else {
      return `${format(filterFrom, "MMM dd, yyyy")} - ${format(filterTo, "MMM dd, yyyy")}`;
    }
  };

  return (
    <>
      <Dialog open={isOpen} onOpenChange={onClose}>
        <DialogContent className="sm:max-w-[600px] max-h-[90vh] flex flex-col">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <AlertTriangle className="h-6 w-6 text-destructive" /> Issues Reported ({getDisplayDateRange()})
            </DialogTitle>
            <DialogDescription>
              List of operational issues reported today.
            </DialogDescription>
          </DialogHeader>
          <div className="flex-grow flex flex-col gap-4 py-4 overflow-hidden">
            {isLoading ? (
              <p className="text-center text-muted-foreground py-8">Loading issues...</p>
            ) : issues.length === 0 ? (
              <p className="text-center text-muted-foreground py-8">No issues reported for this period. Great job!</p>
            ) : (
              <ScrollArea className="flex-grow max-h-[calc(100vh-250px)] border border-border rounded-md p-3">
                <div className="space-y-4">
                  {issues.map((issue: IssueLog) => { // Explicitly type issue
                    const issueTimestamp = parseAndValidateDate(issue.timestamp);
                    return (
                      <div key={issue.id} className="bg-muted/20 p-3 rounded-md border border-border">
                        <div className="flex items-center justify-between text-sm mb-2">
                          <span className="font-semibold flex items-center gap-1">
                            <User className="h-4 w-4 text-muted-foreground" /> {getUserName(issue.userId)}
                          </span>
                          <span className="text-xs text-muted-foreground flex items-center gap-1">
                            <Clock className="h-3 w-3" /> {issueTimestamp ? format(issueTimestamp, "MMM dd, yyyy HH:mm") : "N/A"}
                          </span>
                        </div>
                        <p className="font-medium text-foreground mb-1 flex items-center gap-1">
                          <AlertTriangle className="h-4 w-4 text-destructive" /> {issue.details.issueType}
                        </p>
                        {issue.details.itemName !== "N/A" && (
                          <p className="text-sm text-muted-foreground flex items-center gap-1">
                            <Package className="h-4 w-4" /> Product: {issue.details.itemName} (ID: {issue.details.itemId})
                          </p>
                        )}
                        {issue.details.folderId !== "N/A" && (
                          <p className="text-sm text-muted-foreground flex items-center gap-1">
                            <MapPin className="h-4 w-4" /> Folder: {getFolderName(issue.details.folderId)}
                          </p>
                        )}
                        <p className="text-sm text-muted-foreground mt-2">
                          Description: {issue.details.description}
                        </p>
                        {issue.details.contactInfo !== "N/A" && (
                          <p className="text-xs text-muted-foreground mt-1">
                            Contact: {issue.details.contactInfo}
                          </p>
                        )}
                      </div>
                    );
                  })}
                </div>
              </ScrollArea>
            )}
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={onClose}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
};

export default DailyIssuesDialog;